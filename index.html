<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Archive.org File Browser</title>
</head>
<body>
  <h1>Archive.org File Browser</h1>
  <div id="breadcrumb"></div>
  <div id="info"></div>
  <table id="file-table" border="1">
    <thead>
      <tr>
        <th>Name</th>
        <th>Size</th>
        <th>Format</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function getArchiveIdentifier() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    function getSubdirectory() {
      const urlParams = new URLSearchParams(window.location.search);
      const path = urlParams.get('path');
      return path ? decodeURIComponent(path) : '';
    }

    function buildBreadcrumb(identifier, subdir) {
      const breadcrumbDiv = document.getElementById("breadcrumb");
      breadcrumbDiv.innerHTML = '';

      const baseLink = document.createElement("a");
      baseLink.href = `?id=${encodeURIComponent(identifier)}`;
      baseLink.textContent = identifier;
      breadcrumbDiv.appendChild(baseLink);

      if (subdir) {
        const parts = subdir.split("/");
        let cumulativePath = '';

        parts.forEach((part, index) => {
          breadcrumbDiv.appendChild(document.createTextNode(" / "));
          cumulativePath += (index > 0 ? '/' : '') + part;

          const partLink = document.createElement("a");
          partLink.href = `?id=${encodeURIComponent(identifier)}&path=${encodeURIComponent(cumulativePath)}`;
          partLink.textContent = part;

          breadcrumbDiv.appendChild(partLink);
        });
      }
    }

    async function loadFiles(identifier, subdir) {
      const metadataUrl = `https://archive.org/metadata/${identifier}`;
      const tableBody = document.querySelector("#file-table tbody");
      const infoDiv = document.getElementById("info");
      tableBody.innerHTML = '';

      try {
        const res = await fetch(metadataUrl);
        const json = await res.json();

        buildBreadcrumb(identifier, subdir);
        infoDiv.textContent = `Showing files for: ${identifier}${subdir ? '/' + subdir : ''}`;

        const files = json.files;
        const shownDirs = new Set();

        const filteredFiles = files.filter(f => {
          const parts = f.name.split("/");
          if (subdir) {
            if (!f.name.startsWith(subdir + "/")) return false;
            const remaining = f.name.substring(subdir.length + 1);
            if (remaining.includes("/")) {
              shownDirs.add(remaining.split("/")[0]);
              return false;
            }
            return true;
          } else {
            if (f.name.includes("/")) {
              shownDirs.add(f.name.split("/")[0]);
              return false;
            }
            return true;
          }
        });

        shownDirs.forEach(dir => {
          const row = document.createElement("tr");
          const nameCell = document.createElement("td");
          const sizeCell = document.createElement("td");
          const formatCell = document.createElement("td");

          const link = document.createElement("a");
          link.href = `?id=${encodeURIComponent(identifier)}&path=${encodeURIComponent(subdir ? subdir + '/' + dir : dir)}`;
          link.textContent = dir + "/";

          nameCell.appendChild(link);
          row.appendChild(nameCell);
          row.appendChild(sizeCell);
          row.appendChild(formatCell);
          tableBody.appendChild(row);
        });

        filteredFiles.sort((a, b) => a.name.localeCompare(b.name));

        for (const file of filteredFiles) {
          const row = document.createElement("tr");
          const nameCell = document.createElement("td");
          const sizeCell = document.createElement("td");
          const formatCell = document.createElement("td");

          const link = document.createElement("a");
          link.href = `https://archive.org/download/${identifier}/${file.name}`;
          link.textContent = subdir ? file.name.substring(subdir.length + 1) : file.name;

          nameCell.appendChild(link);
          sizeCell.textContent = file.size || "";
          formatCell.textContent = file.format || "";

          row.appendChild(nameCell);
          row.appendChild(sizeCell);
          row.appendChild(formatCell);
          tableBody.appendChild(row);
        }
      } catch (error) {
        infoDiv.textContent = `Failed to load files for: ${identifier}`;
        console.error(error);
      }
    }

    const id = getArchiveIdentifier();
    const path = getSubdirectory();
    if (id) {
      loadFiles(id, path);
    } else {
      document.getElementById("info").textContent = "Please provide ?id=archive-identifier in the URL.";
    }
  </script>
</body>
</html>
