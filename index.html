<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Archive.org File Browser</title>
</head>
<body>
  <h1>Archive.org File Browser</h1>
  <div id="breadcrumb"></div>
  <div id="info"></div>
  <table id="file-table" border="1">
    <thead>
      <tr>
        <th><button onclick="setSort('name')">Name</button></th>
        <th><button onclick="setSort('size')">Size</button></th>
        <th><button onclick="setSort('format')">Format</button></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let currentSort = getSortField();
    let currentSortDir = getSortDir();

    function setSort(field) {
      if (currentSort === field) {
        currentSortDir *= -1;
      } else {
        currentSort = field;
        currentSortDir = 1;
      }
      const params = new URLSearchParams(window.location.search);
      params.set('sort', currentSort);
      params.set('dir', currentSortDir === 1 ? 'asc' : 'desc');
      window.location.search = params.toString();
    }

    function getArchiveIdentifier() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    function getSubdirectory() {
      const urlParams = new URLSearchParams(window.location.search);
      const path = urlParams.get('path');
      return path ? decodeURIComponent(path) : '';
    }

    function getSortField() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('sort') || 'name';
    }

    function getSortDir() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('dir') === 'desc' ? -1 : 1;
    }

    function buildBreadcrumb(identifier, subdir) {
      const breadcrumbDiv = document.getElementById("breadcrumb");
      breadcrumbDiv.innerHTML = '';

      const baseLink = document.createElement("a");
      baseLink.href = `?id=${encodeURIComponent(identifier)}`;
      baseLink.textContent = identifier;
      breadcrumbDiv.appendChild(baseLink);

      if (subdir) {
        const parts = subdir.split("/");
        let cumulativePath = '';

        parts.forEach((part, index) => {
          breadcrumbDiv.appendChild(document.createTextNode(" / "));
          cumulativePath += (index > 0 ? '/' : '') + part;

          const partLink = document.createElement("a");
          const params = new URLSearchParams(window.location.search);
          params.set('path', cumulativePath);
          partLink.href = `?${params.toString()}`;
          partLink.textContent = part;

          breadcrumbDiv.appendChild(partLink);
        });
      }
    }

    async function loadFiles(identifier, subdir) {
      const metadataUrl = `https://archive.org/metadata/${identifier}`;
      const tableBody = document.querySelector("#file-table tbody");
      const infoDiv = document.getElementById("info");
      tableBody.innerHTML = '';

      try {
        const res = await fetch(metadataUrl);
        const json = await res.json();

        buildBreadcrumb(identifier, subdir);
        infoDiv.textContent = `Showing files for: ${identifier}${subdir ? '/' + subdir : ''}`;

        const files = json.files;
        const shownDirs = new Set();

        const filteredFiles = files.filter(f => {
          const parts = f.name.split("/");
          if (subdir) {
            if (!f.name.startsWith(subdir + "/")) return false;
            const remaining = f.name.substring(subdir.length + 1);
            if (remaining.includes("/")) {
              shownDirs.add(remaining.split("/")[0]);
              return false;
            }
            return true;
          } else {
            if (f.name.includes("/")) {
              shownDirs.add(f.name.split("/")[0]);
              return false;
            }
            return true;
          }
        });

        shownDirs.forEach(dir => {
          const row = document.createElement("tr");
          const nameCell = document.createElement("td");
          const sizeCell = document.createElement("td");
          const formatCell = document.createElement("td");

          const link = document.createElement("a");
          const params = new URLSearchParams(window.location.search);
          params.set('path', subdir ? subdir + '/' + dir : dir);
          link.href = `?${params.toString()}`;
          link.textContent = dir + "/";

          nameCell.appendChild(link);
          row.appendChild(nameCell);
          row.appendChild(sizeCell);
          row.appendChild(formatCell);
          tableBody.appendChild(row);
        });

        filteredFiles.sort((a, b) => {
          let valA = a[currentSort] || '';
          let valB = b[currentSort] || '';

          if (currentSort === 'size') {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
          } else {
            valA = valA.toString().toLowerCase();
            valB = valB.toString().toLowerCase();
          }

          return currentSortDir * (valA > valB ? 1 : valA < valB ? -1 : 0);
        });

        for (const file of filteredFiles) {
          const row = document.createElement("tr");
          const nameCell = document.createElement("td");
          const sizeCell = document.createElement("td");
          const formatCell = document.createElement("td");

          const link = document.createElement("a");
          link.href = `https://archive.org/download/${identifier}/${file.name}`;
          link.textContent = subdir ? file.name.substring(subdir.length + 1) : file.name;

          nameCell.appendChild(link);
          sizeCell.textContent = file.size || "";
          formatCell.textContent = file.format || "";

          row.appendChild(nameCell);
          row.appendChild(sizeCell);
          row.appendChild(formatCell);
          tableBody.appendChild(row);
        }
      } catch (error) {
        infoDiv.textContent = `Failed to load files for: ${identifier}`;
        console.error(error);
      }
    }

    const id = getArchiveIdentifier();
    const path = getSubdirectory();
    if (id) {
      loadFiles(id, path);
    } else {
      document.getElementById("info").textContent = "Please provide ?id=archive-identifier in the URL.";
    }
  </script>
</body>
</html>
